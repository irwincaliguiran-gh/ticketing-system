<!-- Bootstrap 5 -->
<link://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIen.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css
<script src.datatables.net/1.13.8/js/jquery.dataTables.min.js</script>
https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js</script>

<style>
  body { background: #f7f9fb; }
  .app-container { max-width: 1200px; margin: 24px auto; }
  .brand-title { font-weight: 700; }
  .nav-link.active { font-weight: 600; }
  .cursor-pointer { cursor: pointer; }
  .hidden { display: none !important; }
  .dataTables_wrapper .row { width: 100%; margin: 0; }
</style>

<script>
  window.__state = {
    token: null,
    username: null,
    role: null,
    currentView: 'login',
    detailTicketId: null,
    refreshIntervals: {},
    resetToken: ''  // from server if present
  };

  function call(name, args, onSuccess, onError) {
    const fn = google.script.run.withSuccessHandler(onSuccess || function(){}).withFailureHandler(onError || function(err){
      console.error(err);
      alert(err && err.message ? err.message : err);
    });
    if (Array.isArray(args)) fn[name].apply(fn, args);
    else if (args !== undefined) fnname;
    else fnname;
  }

  function setAuth(token, username, role) {
    window.__state.token = token;
    window.__state.username = username;
    window.__state.role = role;
    localStorage.setItem('tk_token', token);
    localStorage.setItem('tk_username', username);
    localStorage.setItem('tk_role', role);
    document.getElementById('navUser').innerText = `${username} (${role})`;
    document.getElementById('navLinks').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'inline-block';
    document.getElementById('changePwdBtn').style.display = 'inline-block';
  }

  function loadAuthFromStorage() {
    const t = localStorage.getItem('tk_token');
    const u = localStorage.getItem('tk_username');
    const r = localStorage.getItem('tk_role');
    if (t && u && r) {
      setAuth(t, u, r);
      showSection('home');
      refreshAll();
    }
  }

  function logout() {
    localStorage.removeItem('tk_token');
    localStorage.removeItem('tk_username');
    localStorage.removeItem('tk_role');
    window.__state = { token:null, username:null, role:null, currentView:'login', detailTicketId:null, refreshIntervals:{}, resetToken:'' };
    document.getElementById('navLinks').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('changePwdBtn').style.display = 'none';
    showSection('login');
  }

  function peso(n) {
    const num = Number(n)||0;
    return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(num);
  }

  function formatDateYMD(d) {
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return '';
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2, '0');
    const dd = String(dt.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  }

  function genTicketId() {
    const d = new Date();
    const pad = (n, s=2) => String(n).padStart(s, '0');
    return `TKT-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}-${pad(d.getMilliseconds(),3)}`;
  }

  function showSection(name) {
    document.querySelectorAll('[data-section]').forEach(el => el.classList.add('hidden'));
    const el = document.querySelector(`[data-section="${name}"]`);
    if (el) el.classList.remove('hidden');
    window.__state.currentView = name;

    document.querySelectorAll('.admin-only').forEach(e => e.classList.toggle('hidden', (window.__state.role !== 'Admin')));

    if (name === 'tickets') loadMyTicketsTable();
    if (name === 'admin') loadAdminPage();
    if (name === 'search') { /* no-op */ }
    if (name === 'submit') document.getElementById('ticketId').value = genTicketId();
    if (name === 'audit') loadAuditLogs();
  }

  function refreshAll() {
    clearInterval(window.__state.refreshIntervals.tickets);
    window.__state.refreshIntervals.tickets = setInterval(() => {
      if (window.__state.currentView === 'tickets') loadMyTicketsTable(false);
      if (window.__state.currentView === 'admin') loadAdminPage(false);
      if (window.__state.currentView === 'details' && window.__state.detailTicketId) reloadDetail();
      if (window.__state.currentView === 'audit') loadAuditLogs(false);
    }, 15000);
  }

  const tables = {};
  function renderDataTable(selector, rows, reset) {
    const el = $(selector);
    if (tables[selector] && reset) {
      tables[selector].clear().destroy();
      el.find('tbody').empty();
    }
    if (!tables[selector]) {
      tables[selector] = el.DataTable({
        data: rows,
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        order: [],
        columns: el.find('thead th').toArray().map(th => ({ title: th.textContent })),
        deferRender: true,
      });
    } else {
      tables[selector].clear();
      tables[selector].rows.add(rows).draw();
    }
  }
