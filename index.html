<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('Includes'); ?>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <span class="navbar-brand brand-title">Ticketing System</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navbarsExample" class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="navLinks" style="display:none;">
            <li class="nav-item">#Home</a></li>
            <li class="nav-item">#View Tickets</a></li>
            <li class="nav-item">#Submit New Ticket</a></li>
            <li class="nav-item">#Search Tickets</a></li>
            <li class="nav-item admin-only hidden">#Admin</a></li>
            <li class="nav-item admin-only hidden">#Audit Logs</a></li>
          </ul>
          <div class="d-flex align-items-center gap-2">
            <span class="navbar-text text-light" id="navUser"></span>
            <button class="btn btn-outline-light" id="changePwdBtn" style="display:none;" data-bs-toggle="modal" data-bs-target="#modalChangePwd">Change Password</button>
            <button class="btn btn-outline-light" id="logoutBtn" style="display:none;" onclick="logout()">Sign out</button>
          </div>
        </div>
      </div>
    </nav>

    <div class="app-container">

      <!-- LOGIN / REGISTER / RESET -->
      <div data-section="login">
        <div class="row justify-content-center">
          <div class="col-lg-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <h3 class="mb-3">Welcome</h3>
                <ul class="nav nav-tabs" id="authTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabSignIn" type="button" role="tab">Sign In</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabRegister" type="button" role="tab">Create Account</button>
                  </li>
                </ul>
                <div class="tab-content p-3 border border-top-0 rounded-bottom">
                  <div class="tab-pane fade show active" id="tabSignIn" role="tabpanel">
                    <form onsubmit="event.preventDefault(); signIn();">
                      <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="si_username" class="form-control" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" id="si_password" class="form-control" required>
                      </div>
                      <button class="btn btn-primary w-100" type="submit">Sign In</button>
                      <div class="d-flex justify-content-between mt-2">
                        <div class="form-text">Admin account: <b>admin / admin</b></div>
                        <Forgot password?</a>
                      </div>
                    </form>
                  </div>
                  <div class="tab-pane fade" id="tabRegister" role="tabpanel">
                    <form onsubmit="event.preventDefault(); register();">
                      <div class="row">
                        <div class="mb-3 col-md-6">
                          <label class="form-label">Username</label>
                          <input type="text" id="reg_username" class="form-control" required>
                        </div>
                        <div class="mb-3 col-md-6">
                          <label class="form-label">Email</label>
                          <input type="email" id="reg_email" class="form-control" required>
                        </div>
                      </div>
                      <div class="row">
                        <div class="mb-3 col-md-6">
                          <label class="form-label">Password</label>
                          <input type="password" id="reg_password" class="form-control" required>
                        </div>
                        <div class="mb-3 col-md-6">
                          <label class="form-label">Contact Number</label>
                          <input type="text" id="reg_contact" class="form-control" required>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Department</label>
                        <input type="text" id="reg_department" class="form-control" required>
                      </div>
                      <button class="btn btn-success w-100" type="submit">Create Account</button>
                      <div class="form-text mt-2">After creating an account, an admin must approve your application.</div>
                    </form>
                  </div>
                </div>

                <!-- RESET PASSWORD SECTION (when opened by token link) -->
                <div id="resetSection" class="mt-4" style="display:none;">
                  <h5>Reset Password</h5>
                  <form onsubmit="event.preventDefault(); resetPasswordWithToken();">
                    <div class="mb-3">
                      <label class="form-label">New Password</label>
                      <input type="password" id="rp_new" class="form-control" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Confirm New Password</label>
                      <input type="password" id="rp_confirm" class="form-control" required>
                    </div>
                    <button class="btn btn-primary">Set New Password</button>
                  </form>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div> <!-- /login -->

      <!-- HOME -->
      <div data-section="home" class="hidden">
        <div class="alert alert-info">Use the navigation to view your tickets, submit a new one, or search. Admins can approve users and tickets.</div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" onclick="showSection('tickets')">Go to My Tickets</button>
          <button class="btn btn-primary" onclick="showSection('submit')">Submit New Ticket</button>
          <button class="btn btn-outline-dark" onclick="showSection('search')">Search Tickets</button>
        </div>
      </div>

      <!-- VIEW TICKETS -->
      <div data-section="tickets" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>My Tickets</h4>
          <div class="d-flex gap-2">
            <div class="btn-group">
              <button class="btn btn-outline-primary" onclick="exportPdf('mine')">PDF</button>
              <button class="btn btn-outline-primary" onclick="exportCsv('mine')">CSV</button>
              <button class="btn btn-outline-primary" onclick="exportXlsx('mine')">Excel</button>
            </div>
            <button class="btn btn-outline-secondary" onclick="loadMyTicketsTable()">Refresh</button>
          </div>
        </div>
        <div class="table-responsive">
          <table id="tblMyTickets" class="table table-striped table-hover table-bordered w-100">
            <thead>
              <tr>
                <th>Ticket ID</th>
                <th>Project #</th>
                <th>Project Name</th>
                <th>Manager</th>
                <th>Budget</th>
                <th>Start</th>
                <th>End</th>
                <th>Priority</th>
                <th>Team</th>
                <th>Status</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- SUBMIT NEW TICKET -->
      <div data-section="submit" class="hidden">
        <h4>Submit New Ticket</h4>
        <form onsubmit="event.preventDefault(); submitTicket();">
          <div class="row">
            <div class="mb-3 col-md-4">
              <label class="form-label">Ticket ID</label>
              <input class="form-control" id="ticketId" readonly>
              <div class="form-text">Auto-generated from current date & time.</div>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">Project Number</label>
              <input class="form-control" id="projectNumber" required>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">Priority Level</label>
              <select class="form-select" id="priority" required>
                <option value="">-- Choose --</option>
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
                <option>Critical</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Project Name</label>
              <input class="form-control" id="projectName" required>
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Project Manager</label>
              <input class="form-control" id="projectManager" required>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-md-4">
              <label class="form-label">Budget (₱)</label>
              <input type="number" min="0" step="0.01" class="form-control" id="budget" required>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" id="startDate" required>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">End Date</label>
              <input type="date" class="form-control" id="endDate" required>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Assigned Team</label>
              <input class="form-control" id="assignedTeam">
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Remarks</label>
              <input class="form-control" id="remarks">
            </div>
          </div>
          <button class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-outline-secondary" onclick="showSection('tickets')">Back to My Tickets</button>
        </form>
      </div>

      <!-- SIMPLE SEARCH + ADVANCED FILTERS -->
      <div data-section="search" class="hidden">
        <h4>Search Tickets</h4>
        <div class="input-group mb-3">
          <input id="searchQuery" type="text" class="form-control" placeholder="Search by ID, project #, name, manager, priority, team, status...">
          <button class="btn btn-outline-primary" onclick="performSearch()">Search</button>
        </div>

        <div class="accordion mb-3" id="advAcc">
          <div class="accordion-item">
            <h2 class="accordion-header" id="advHead">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advBody">Advanced Filters</button>
            </h2>
            <div id="advBody" class="accordion-collapse collapse">
              <div class="accordion-body">
                <form onsubmit="event.preventDefault(); performAdvancedSearch();">
                  <div class="row g-3">
                    <div class="col-md-3">
                      <label class="form-label">Ticket ID</label>
                      <input id="af_ticketId" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Project #</label>
                      <input id="af_projectNumber" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Project Name</label>
                      <input id="af_projectName" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Manager</label>
                      <input id="af_projectManager" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Assigned Team</label>
                      <input id="af_assignedTeam" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Priority</label>
                      <select id="af_priority" class="form-select" multiple>
                        <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
                      </select>
                      <div class="form-text">Ctrl/Cmd-click for multiple</div>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Status</label>
                      <select id="af_status" class="form-select" multiple>
                        <option>Pending</option><option>Approved</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Budget Min (₱)</label>
                      <input id="af_budgetMin" type="number" step="0.01" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Budget Max (₱)</label>
                      <input id="af_budgetMax" type="number" step="0.01" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Start From</label>
                      <input id="af_startFrom" type="date" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Start To</label>
                      <input id="af_startTo" type="date" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">End From</label>
                      <input id="af_endFrom" type="date" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">End To</label>
                      <input id="af_endTo" type="date" class="form-control">
                    </div>
                  </div>
                  <div class="mt-3">
                    <button class="btn btn-primary">Apply Filters</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="resetAdvancedFilters()">Reset</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table id="tblSearch" class="table table-striped table-hover table-bordered w-100">
            <thead>
              <tr>
                <th>Ticket ID</th>
                <th>Project #</th>
                <th>Project Name</th>
                <th>Manager</th>
                <th>Budget</th>
                <th>Start</th>
                <th>End</th>
                <th>Status</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- DETAILS PAGE -->
      <div data-section="details" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>Ticket Details</h4>
          <button class="btn btn-outline-secondary" onclick="showSection('tickets')">Back</button>
        </div>
        <div id="detailsCard" class="card shadow-sm">
          <div class="card-body">
            <div id="detailsContent">Loading...</div>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div data-section="admin" class="hidden">
        <div class="admin-only hidden">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4>Admin Panel</h4>
            <div class="d-flex gap-2">
              <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="exportPdf('all')">PDF</button>
                <button class="btn btn-outline-primary" onclick="exportCsv('all')">CSV</button>
                <button class="btn btn-outline-primary" onclick="exportXlsx('all')">Excel</button>
              </div>
              <button class="btn btn-outline-secondary" onclick="loadAdminPage()">Refresh</button>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header">Pending User Applications</div>
            <div class="card-body">
              <table id="tblPendingUsers" class="table table-striped table-hover table-bordered w-100">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Contact</th>
                    <th>Department</th>
                    <th>Approve</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-header">All Tickets</div>
            <div class="card-body">
              <table id="tblAllTickets" class="table table-striped table-hover table-bordered w-100">
                <thead>
                  <tr>
                    <th>Ticket ID</th>
                    <th>Project #</th>
                    <th>Project Name</th>
                    <th>Manager</th>
                    <th>Budget</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Priority</th>
                    <th>Team</th>
                    <th>Status</th>
                    <th>Approve</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <!-- AUDIT LOGS (ADMIN) -->
      <div data-section="audit" class="hidden">
        <div class="admin-only hidden">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4>Audit Logs</h4>
            <button class="btn btn-outline-secondary" onclick="loadAuditLogs()">Refresh</button>
          </div>
          <div class="table-responsive">
            <table id="tblAudit" class="table table-striped table-hover table-bordered w-100">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Actor</th>
                  <th>Action</th>
                  <th>Target</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div><!-- /app-container -->

    <!-- Modals -->
    <div class="modal fade" id="modalChangePwd" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" onsubmit="event.preventDefault(); doChangePassword();">
          <div class="modal-header">
            <h5 class="modal-title">Change Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input type="password" id="cp_current" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input type="password" id="cp_new" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input type="password" id="cp_confirm" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary">Update Password</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="modalForgot" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" onsubmit="event.preventDefault(); doRequestReset();">
          <div class="modal-header">
            <h5 class="modal-title">Forgot Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Enter your account email. If it exists, we’ll send a reset link valid for 1 hour.</p>
            <input type="email" id="fp_email" class="form-control" placeholder="you@company.com" required>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary">Send Reset Link</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      fetch('include.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('include-container').innerHTML = data;
    });

      /* ============================
         AUTH + PASSWORD
         ============================ */

      function signIn() {
        const username = document.getElementById('si_username').value.trim();
        const password = document.getElementById('si_password').value;
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert(res.message);
          setAuth(res.token, res.username, res.role);
          showSection('home');
          refreshAll();
        }).withFailureHandler(err => alert(err.message || err)).login(username, password);
      }

      function register() {
        const payload = {
          username: document.getElementById('reg_username').value.trim(),
          email: document.getElementById('reg_email').value.trim(),
          password: document.getElementById('reg_password').value,
          contact: document.getElementById('reg_contact').value.trim(),
          department: document.getElementById('reg_department').value.trim()
        };
        google.script.run.withSuccessHandler(res => alert(res.message))
          .withFailureHandler(err => alert(err.message || err))
          .registerUser(payload);
      }

      function openForgot() {
        const modal = new bootstrap.Modal(document.getElementById('modalForgot'));
        modal.show();
      }

      function doRequestReset() {
        const email = document.getElementById('fp_email').value.trim();
        google.script.run.withSuccessHandler(res => {
          alert(res.message);
          bootstrap.Modal.getInstance(document.getElementById('modalForgot')).hide();
        }).withFailureHandler(err => alert(err.message || err)).requestPasswordReset(email);
      }

      function doChangePassword() {
        const cur = document.getElementById('cp_current').value;
        const np = document.getElementById('cp_new').value;
        const cf = document.getElementById('cp_confirm').value;
        if (np !== cf) return alert('New passwords do not match.');
        google.script.run.withSuccessHandler(res => {
          alert(res.message);
          if (res.ok) bootstrap.Modal.getInstance(document.getElementById('modalChangePwd')).hide();
        }).withFailureHandler(err => alert(err.message || err)).changePassword(window.__state.token, cur, np);
      }

      function resetPasswordWithToken() {
        const np = document.getElementById('rp_new').value;
        const cf = document.getElementById('rp_confirm').value;
        if (np !== cf) return alert('New passwords do not match.');
        const t = window.__state.resetToken;
        if (!t) return alert('Invalid or missing reset token.');
        google.script.run.withSuccessHandler(res => {
          alert(res.message);
          if (res.ok) location.href = location.origin + location.pathname; // back to normal login
        }).withFailureHandler(err => alert(err.message || err)).resetPasswordWithToken(t, np);
      }

      /* ============================
         TICKETS (USER)
         ============================ */

      function loadMyTicketsTable(reset=true) {
        if (!window.__state.token) return;
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Failed to load tickets');
          const rows = res.tickets.map(t => ([
            t.ticketId, t.projectNumber, t.projectName, t.projectManager, peso(t.budget),
            formatDateYMD(t.startDate), formatDateYMD(t.endDate), t.priority, t.assignedTeam,
            t.status,
            `<button class="btn btn-sm btn-outline-primary" onclick="openDetails('${t.ticketId}')">Open</button>`
          ]));
          renderDataTable('#tblMyTickets', rows, reset);
        }).withFailureHandler(err => alert(err.message || err)).listMyTickets(window.__state.token);
      }

      function submitTicket() {
        if (!window.__state.token) return alert('Please sign in.');
        const payload = {
          ticketId: document.getElementById('ticketId').value.trim(),
          projectNumber: document.getElementById('projectNumber').value.trim(),
          projectName: document.getElementById('projectName').value.trim(),
          projectManager: document.getElementById('projectManager').value.trim(),
          budget: document.getElementById('budget').value,
          startDate: document.getElementById('startDate').value,
          endDate: document.getElementById('endDate').value,
          priority: document.getElementById('priority').value,
          assignedTeam: document.getElementById('assignedTeam').value.trim(),
          remarks: document.getElementById('remarks').value.trim()
        };
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert(res.message);
          alert(res.message);
          document.querySelector('[data-section="submit"] form').reset();
          document.getElementById('ticketId').value = genTicketId();
          showSection('tickets');
          loadMyTicketsTable();
        }).withFailureHandler(err => alert(err.message || err)).createTicket(window.__state.token, payload);
      }

      /* ============================
         SEARCH & DETAILS
         ============================ */
      function performSearch() {
        const q = document.getElementById('searchQuery').value.trim();
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Search failed');
          const rows = res.tickets.map(t => ([
            t.ticketId, t.projectNumber, t.projectName, t.projectManager,
            peso(t.budget), formatDateYMD(t.startDate), formatDateYMD(t.endDate), t.status,
            `<button class="btn btn-sm btn-outline-primary" onclick="openDetails('${t.ticketId}')">Open</button>`
          ]));
          renderDataTable('#tblSearch', rows, true);
        }).withFailureHandler(err => alert(err.message || err)).searchTickets(window.__state.token, q);
      }

      function getMultiSelectValues(id) {
        return Array.from(document.getElementById(id).selectedOptions).map(o => o.value);
      }

      function performAdvancedSearch() {
        const criteria = {
          ticketId: document.getElementById('af_ticketId').value.trim(),
          projectNumber: document.getElementById('af_projectNumber').value.trim(),
          projectName: document.getElementById('af_projectName').value.trim(),
          projectManager: document.getElementById('af_projectManager').value.trim(),
          assignedTeam: document.getElementById('af_assignedTeam').value.trim(),
          priority: getMultiSelectValues('af_priority'),
          status: getMultiSelectValues('af_status'),
          budgetMin: document.getElementById('af_budgetMin').value,
          budgetMax: document.getElementById('af_budgetMax').value,
          startFrom: document.getElementById('af_startFrom').value,
          startTo: document.getElementById('af_startTo').value,
          endFrom: document.getElementById('af_endFrom').value,
          endTo: document.getElementById('af_endTo').value
        };
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Advanced search failed');
          const rows = res.tickets.map(t => ([
            t.ticketId, t.projectNumber, t.projectName, t.projectManager,
            peso(t.budget), formatDateYMD(t.startDate), formatDateYMD(t.endDate), t.status,
            `<button class="btn btn-sm btn-outline-primary" onclick="openDetails('${t.ticketId}')">Open</button>`
          ]));
          renderDataTable('#tblSearch', rows, true);
        }).withFailureHandler(err => alert(err.message || err)).advancedSearch(window.__state.token, criteria);
      }

      function resetAdvancedFilters() {
        ['af_ticketId','af_projectNumber','af_projectName','af_projectManager','af_assignedTeam',
         'af_budgetMin','af_budgetMax','af_startFrom','af_startTo','af_endFrom','af_endTo'].forEach(id => document.getElementById(id).value='');
        ['af_priority','af_status'].forEach(id => Array.from(document.getElementById(id).options).forEach(o => o.selected = false));
      }

      function openDetails(ticketId) {
        window.__state.detailTicketId = ticketId;
        showSection('details');
        reloadDetail();
      }

      function reloadDetail() {
        const q = window.__state.detailTicketId;
        if (!q) return;
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return;
          const t = (res.tickets || [])[0];
          if (!t) {
            document.getElementById('detailsContent').innerHTML = `<div class="alert alert-warning">Ticket not found (it may have been deleted).</div>`;
            return;
          }
          document.getElementById('detailsContent').innerHTML = `
            <div class="row">
              <div class="col-md-6">
                <dl class="row">
                  <dt class="col-sm-4">Ticket ID</dt><dd class="col-sm-8">${t.ticketId}</dd>
                  <dt class="col-sm-4">Project #</dt><dd class="col-sm-8">${t.projectNumber}</dd>
                  <dt class="col-sm-4">Project Name</dt><dd class="col-sm-8">${t.projectName}</dd>
                  <dt class="col-sm-4">Manager</dt><dd class="col-sm-8">${t.projectManager}</dd>
                  <dt class="col-sm-4">Budget</dt><dd class="col-sm-8">${peso(t.budget)}</dd>
                </dl>
              </div>
              <div class="col-md-6">
                <dl class="row">
                  <dt class="col-sm-4">Start</dt><dd class="col-sm-8">${formatDateYMD(t.startDate)}</dd>
                  <dt class="col-sm-4">End</dt><dd class="col-sm-8">${formatDateYMD(t.endDate)}</dd>
                  <dt class="col-sm-4">Priority</dt><dd class="col-sm-8">${t.priority}</dd>
                  <dt class="col-sm-4">Team</dt><dd class="col-sm-8">${t.assignedTeam || '-'}</dd>
                  <dt class="col-sm-4">Status</dt><dd class="col-sm-8">${t.status}</dd>
                </dl>
              </div>
            </div>
            <div><b>Remarks:</b><br>${(t.remarks||'').replaceAll('<','&lt;')}</div>
          `;
        }).withFailureHandler(err => console.error(err)).searchTickets(window.__state.token, q);
      }

      /* ============================
         ADMIN
         ============================ */

      function loadAdminPage(reset=true) {
        if (window.__state.role !== 'Admin') return;
        google.script.run.withSuccessHandler(res => {
          const rows = (res.users || []).map(u => ([
            u.username, u.email, u.contact, u.department,
            `<button class="btn btn-sm btn-success" onclick="approveUser('${u.username}')">Approve</button>`
          ]));
          renderDataTable('#tblPendingUsers', rows, true);
        }).withFailureHandler(err => alert(err.message || err)).listPendingUsers(window.__state.token);

        google.script.run.withSuccessHandler(res => {
          const rows = (res.tickets || []).map(t => ([
            t.ticketId, t.projectNumber, t.projectName, t.projectManager,
            peso(t.budget), formatDateYMD(t.startDate), formatDateYMD(t.endDate), t.priority, t.assignedTeam,
            t.status,
            (t.status === 'Pending')
              ? `<button class="btn btn-sm btn-primary" onclick="approveTicketAdmin('${t.ticketId}')">Approve</button>` : '',
            `<button class="btn btn-sm btn-danger" onclick="deleteTicketAdmin('${t.ticketId}')">Delete</button>`
          ]));
          renderDataTable('#tblAllTickets', rows, true);
        }).withFailureHandler(err => alert(err.message || err)).listAllTickets(window.__state.token);
      }

      function approveUser(username) {
        google.script.run.withSuccessHandler(res => { alert(res.message); loadAdminPage(false); })
          .withFailureHandler(err => alert(err.message || err))
          .approveUser(window.__state.token, username);
      }

      function approveTicketAdmin(ticketId) {
        if (!confirm('Approve this ticket?')) return;
        google.script.run.withSuccessHandler(res => { alert(res.message); loadAdminPage(false); })
          .withFailureHandler(err => alert(err.message || err))
          .approveTicket(window.__state.token, ticketId);
      }

      function deleteTicketAdmin(ticketId) {
        if (!confirm('Delete this ticket? This cannot be undone.')) return;
        google.script.run.withSuccessHandler(res => { alert(res.message); loadAdminPage(false); })
          .withFailureHandler(err => alert(err.message || err))
          .deleteTicket(window.__state.token, ticketId);
      }

      /* ============================
         EXPORTS
         ============================ */

      function downloadBase64(base64, filename, mime) {
        const link = document.createElement('a');
        link.href = `data:${mime};base64,${base64}`;
        link.download = filename;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
      }

      function exportPdf(scope) {
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Export failed.');
          downloadBase64(res.base64, res.filename || 'tickets.pdf', 'application/pdf');
        }).withFailureHandler(err => alert(err.message || err)).exportTicketsPdf(window.__state.token, scope);
      }

      function exportCsv(scope) {
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Export failed.');
          downloadBase64(res.base64, res.filename || 'tickets.csv', 'text/csv');
        }).withFailureHandler(err => alert(err.message || err)).exportTicketsCsv(window.__state.token, scope);
      }

      function exportXlsx(scope) {
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Export failed.');
          downloadBase64(res.base64, res.filename || 'tickets.xlsx', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        }).withFailureHandler(err => alert(err.message || err)).exportTicketsExcel(window.__state.token, scope);
      }

      /* ============================
         AUDIT
         ============================ */

      function loadAuditLogs(reset=true) {
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Failed to load audit logs');
          const rows = (res.logs || []).map(l => ([
            new Date(l.timestamp).toLocaleString(), l.actor, l.action, l.target, l.details
          ]));
          renderDataTable('#tblAudit', rows, true);
        }).withFailureHandler(err => alert(err.message || err)).listAudit(window.__state.token, 500);
      }

      /* ============================
         On load
         ============================ */
      (function init() {
        // Read reset token from server template
        const tokenFromServer = '<?= resetToken ?>';
        if (tokenFromServer) {
          window.__state.resetToken = tokenFromServer;
          document.getElementById('resetSection').style.display = 'block';
        }

        showSection('login');
        loadAuthFromStorage();

        const navVisible = !!localStorage.getItem('tk_token');
        document.getElementById('navLinks').style.display = navVisible ? 'block' : 'none';
        document.getElementById('logoutBtn').style.display = navVisible ? 'inline-block' : 'none';
        document.getElementById('changePwdBtn').style.display = navVisible ? 'inline-block' : 'none';
      })();
    </script>

  </body>
</html>
