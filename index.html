<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('Includes'); ?>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <span class="navbar-brand brand-title">FPI OS Ticketing System</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navbarsExample" class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="navLinks" style="display:none;">
            <li class="nav-item">#Home</a></li>
            <li class="nav-item">#View Tickets</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="showi class="nav-item">#Search Tickets</a></li>
            <li class="nav-item admin-only hidden">#Admin</a></li>
          </ul>
          <span class="navbar-text text-light me-3" id="navUser"></span>
          <button class="btn btn-outline-light" id="logoutBtn" style="display:none;" onclick="logout()">Sign out</button>
        </div>
      </div>
    </nav>

    <div class="app-container">

      <!-- LOGIN / REGISTER -->
      <div data-section="login">
        <div class="row justify-content-center">
          <div class="col-lg-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <h3 class="mb-3">Welcome</h3>
                <ul class="nav nav-tabs" id="authTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabSignIn" type="button" role="tab">Sign In</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabRegister" type="button" role="tab">Create Account</button>
                  </li>
                </ul>
                <div class="tab-content p-3 border border-top-0 rounded-bottom">
                  <div class="tab-pane fade show active" id="tabSignIn" role="tabpanel">
                    <form onsubmit="event.preventDefault(); signIn();">
                      <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="si_username" class="form-control" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" id="si_password" class="form-control" required>
                      </div>
                      <button class="btn btn-primary w-100" type="submit">Sign In</button>
                      <div class="form-text mt-2">Admin account: <b>admin / admin</b></div>
                    </form>
                  </div>
                  <div class="tab-pane fade" id="tabRegister" role="tabpanel">
                    <form onsubmit="event.preventDefault(); register();">
                      <div class="row">
                        <div class="mb-3 col-md-6">
                          <label class="form-label">Username</label>
                          <input type="text" id="reg_username" class="form-control" required>
                        </div>
                        <div class="mb-3 col-md-6">
                          <label class="form-label">Email</label>
                          <input type="email" id="reg_email" class="form-control" required>
                        </div>
                      </div>
                      <div class="row">
                        <div class="mb-3 col-md-6">
                          <label class="form-label">Password</label>
                          <input type="password" id="reg_password" class="form-control" required>
                        </div>
                        <div class="mb-3 col-md-6">
                          <label class="form-label">Contact Number</label>
                          <input type="text" id="reg_contact" class="form-control" required>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Department</label>
                        <input type="text" id="reg_department" class="form-control" required>
                      </div>
                      <button class="btn btn-success w-100" type="submit">Create Account</button>
                      <div class="form-text mt-2">After creating an account, an admin must approve your application.</div>
                    </form>
                  </div>
                </div>
              </div>
            </div> <!-- /card -->
          </div>
        </div>
      </div> <!-- /login -->

      <!-- HOME -->
      <div data-section="home" class="hidden">
        <div class="alert alert-info">Use the navigation to view your tickets, submit a new one, or search. Admins can approve users and tickets.</div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" onclick="showSection('tickets')">Go to My Tickets</button>
          <button class="btn btn-primary" onclick="showSection('submit')">Submit New Ticket</button>
          <button class="btn btn-outline-dark" onclick="showSection('search')">Search Tickets</button>
        </div>
      </div>

      <!-- VIEW TICKETS -->
      <div data-section="tickets" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>My Tickets</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="exportPdf('mine')">Export to PDF</button>
            <button class="btn btn-outline-secondary" onclick="loadMyTicketsTable()">Refresh</button>
          </div>
        </div>
        <div class="table-responsive">
          <table id="tblMyTickets" class="table table-striped table-hover table-bordered w-100">
            <thead>
              <tr>
                <th>Ticket ID</th>
                <th>Project #</th>
                <th>Project Name</th>
                <th>Manager</th>
                <th>Budget</th>
                <th>Start</th>
                <th>End</th>
                <th>Priority</th>
                <th>Team</th>
                <th>Status</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- SUBMIT NEW TICKET -->
      <div data-section="submit" class="hidden">
        <h4>Submit New Ticket</h4>
        <form onsubmit="event.preventDefault(); submitTicket();">
          <div class="row">
            <div class="mb-3 col-md-4">
              <label class="form-label">Ticket ID</label>
              <input class="form-control" id="ticketId" readonly>
              <div class="form-text">Auto-generated from current date & time.</div>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">Project Number</label>
              <input class="form-control" id="projectNumber" required>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">Priority Level</label>
              <select class="form-select" id="priority" required>
                <option value="">-- Choose --</option>
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
                <option>Critical</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Project Name</label>
              <input class="form-control" id="projectName" required>
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Project Manager</label>
              <input class="form-control" id="projectManager" required>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-md-4">
              <label class="form-label">Budget (â‚±)</label>
              <input type="number" min="0" step="0.01" class="form-control" id="budget" required>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" id="startDate" required>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">End Date</label>
              <input type="date" class="form-control" id="endDate" required>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Assigned Team</label>
              <input class="form-control" id="assignedTeam">
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Remarks</label>
              <input class="form-control" id="remarks">
            </div>
          </div>
          <button class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-outline-secondary" onclick="showSection('tickets')">Back to My Tickets</button>
        </form>
      </div>

      <!-- SEARCH -->
      <div data-section="search" class="hidden">
        <h4>Search Tickets</h4>
        <div class="input-group mb-3">
          <input id="searchQuery" type="text" class="form-control" placeholder="Search by ID, project #, name, manager, priority, team, status...">
          <button class="btn btn-outline-primary" onclick="performSearch()">Search</button>
        </div>
        <div class="table-responsive">
          <table id="tblSearch" class="table table-striped table-hover table-bordered w-100">
            <thead>
              <tr>
                <th>Ticket ID</th>
                <th>Project #</th>
                <th>Project Name</th>
                <th>Manager</th>
                <th>Budget</th>
                <th>Start</th>
                <th>End</th>
                <th>Status</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- DETAILS PAGE -->
      <div data-section="details" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>Ticket Details</h4>
          <button class="btn btn-outline-secondary" onclick="showSection('tickets')">Back</button>
        </div>
        <div id="detailsCard" class="card shadow-sm">
          <div class="card-body">
            <div id="detailsContent">Loading...</div>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div data-section="admin" class="hidden">
        <div class="admin-only hidden">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4>Admin Panel</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary" onclick="exportPdf('all')">Export All to PDF</button>
              <button class="btn btn-outline-secondary" onclick="loadAdminPage()">Refresh</button>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header">Pending User Applications</div>
            <div class="card-body">
              <table id="tblPendingUsers" class="table table-striped table-hover table-bordered w-100">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Contact</th>
                    <th>Department</th>
                    <th>Approve</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-header">All Tickets</div>
            <div class="card-body">
              <table id="tblAllTickets" class="table table-striped table-hover table-bordered w-100">
                <thead>
                  <tr>
                    <th>Ticket ID</th>
                    <th>Project #</th>
                    <th>Project Name</th>
                    <th>Manager</th>
                    <th>Budget</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Priority</th>
                    <th>Team</th>
                    <th>Status</th>
                    <th>Approve</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

    </div><!-- /app-container -->

    <script>
      /* ============================
         AUTH
         ============================ */

      function signIn() {
        const username = document.getElementById('si_username').value.trim();
        const password = document.getElementById('si_password').value;
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert(res.message);
          setAuth(res.token, res.username, res.role);
          document.getElementById('navLinks').style.display = 'block';
          document.getElementById('logoutBtn').style.display = 'inline-block';
          showSection('home');
          refreshAll();
        }).withFailureHandler(err => alert(err.message || err)).login(username, password);
      }

      function register() {
        const payload = {
          username: document.getElementById('reg_username').value.trim(),
          email: document.getElementById('reg_email').value.trim(),
          password: document.getElementById('reg_password').value,
          contact: document.getElementById('reg_contact').value.trim(),
          department: document.getElementById('reg_department').value.trim()
        };
        google.script.run.withSuccessHandler(res => {
          alert(res.message);
        }).withFailureHandler(err => alert(err.message || err)).registerUser(payload);
      }

      /* ============================
         TICKETS (USER)
         ============================ */

      let myTicketsTable;
      function loadMyTicketsTable(reset=true) {
        if (!window.__state.token) return;
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Failed to load tickets');
          const rows = res.tickets.map(t => ([
            t.ticketId,
            t.projectNumber,
            t.projectName,
            t.projectManager,
            peso(t.budget),
            formatDateYMD(t.startDate),
            formatDateYMD(t.endDate),
            t.priority,
            t.assignedTeam,
            t.status,
            `<button class="btn btn-sm btn-outline-primary" onclick="openDetails('${t.ticketId}')">Open</button>`
          ]));
          renderDataTable('#tblMyTickets', rows, reset);
          refreshAll();
        }).withFailureHandler(err => alert(err.message || err)).listMyTickets(window.__state.token);
      }

      function submitTicket() {
        if (!window.__state.token) return alert('Please sign in.');
        const payload = {
          ticketId: document.getElementById('ticketId').value.trim(),
          projectNumber: document.getElementById('projectNumber').value.trim(),
          projectName: document.getElementById('projectName').value.trim(),
          projectManager: document.getElementById('projectManager').value.trim(),
          budget: document.getElementById('budget').value,
          startDate: document.getElementById('startDate').value,
          endDate: document.getElementById('endDate').value,
          priority: document.getElementById('priority').value,
          assignedTeam: document.getElementById('assignedTeam').value.trim(),
          remarks: document.getElementById('remarks').value.trim()
        };
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert(res.message);
          alert(res.message);
          // Reset form and generate new ID
          document.querySelector('[data-section="submit"] form').reset();
          document.getElementById('ticketId').value = genTicketId();
          showSection('tickets');
          loadMyTicketsTable();
        }).withFailureHandler(err => alert(err.message || err)).createTicket(window.__state.token, payload);
      }

      /* ============================
         SEARCH & DETAILS
         ============================ */
      let searchTable;
      function performSearch() {
        const q = document.getElementById('searchQuery').value.trim();
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Search failed');
          const rows = res.tickets.map(t => ([
            t.ticketId, t.projectNumber, t.projectName, t.projectManager,
            peso(t.budget), formatDateYMD(t.startDate), formatDateYMD(t.endDate), t.status,
            `<button class="btn btn-sm btn-outline-primary" onclick="openDetails('${t.ticketId}')">Open</button>`
          ]));
          renderDataTable('#tblSearch', rows, true);
        }).withFailureHandler(err => alert(err.message || err)).searchTickets(window.__state.token, q);
      }

      function openDetails(ticketId) {
        window.__state.detailTicketId = ticketId;
        showSection('details');
        reloadDetail();
        refreshAll();
      }

      function reloadDetail() {
        const q = window.__state.detailTicketId;
        if (!q) return;
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return;
          const t = (res.tickets || [])[0];
          if (!t) {
            document.getElementById('detailsContent').innerHTML = `<div class="alert alert-warning">Ticket not found (it may have been deleted).</div>`;
            return;
          }
          document.getElementById('detailsContent').innerHTML = `
            <div class="row">
              <div class="col-md-6">
                <dl class="row">
                  <dt class="col-sm-4">Ticket ID</dt><dd class="col-sm-8">${t.ticketId}</dd>
                  <dt class="col-sm-4">Project #</dt><dd class="col-sm-8">${t.projectNumber}</dd>
                  <dt class="col-sm-4">Project Name</dt><dd class="col-sm-8">${t.projectName}</dd>
                  <dt class="col-sm-4">Manager</dt><dd class="col-sm-8">${t.projectManager}</dd>
                  <dt class="col-sm-4">Budget</dt><dd class="col-sm-8">${peso(t.budget)}</dd>
                </dl>
              </div>
              <div class="col-md-6">
                <dl class="row">
                  <dt class="col-sm-4">Start</dt><dd class="col-sm-8">${formatDateYMD(t.startDate)}</dd>
                  <dt class="col-sm-4">End</dt><dd class="col-sm-8">${formatDateYMD(t.endDate)}</dd>
                  <dt class="col-sm-4">Priority</dt><dd class="col-sm-8">${t.priority}</dd>
                  <dt class="col-sm-4">Team</dt><dd class="col-sm-8">${t.assignedTeam || '-'}</dd>
                  <dt class="col-sm-4">Status</dt><dd class="col-sm-8">${t.status}</dd>
                </dl>
              </div>
            </div>
            <div><b>Remarks:</b><br>${(t.remarks||'').replaceAll('<','&lt;')}</div>
          `;
        }).withFailureHandler(err => console.error(err)).searchTickets(window.__state.token, q);
      }

      /* ============================
         ADMIN
         ============================ */

      let pendingUsersTable, allTicketsTable;

      function loadAdminPage(reset=true) {
        if (window.__state.role !== 'Admin') return;
        // Pending users
        google.script.run.withSuccessHandler(res => {
          const rows = (res.users || []).map(u => ([
            u.username, u.email, u.contact, u.department,
            `<button class="btn btn-sm btn-success" onclick="approveUser('${u.username}')">Approve</button>`
          ]));
          renderDataTable('#tblPendingUsers', rows, true);
        }).withFailureHandler(err => alert(err.message || err)).listPendingUsers(window.__state.token);

        // All tickets
        google.script.run.withSuccessHandler(res => {
          const rows = (res.tickets || []).map(t => ([
            t.ticketId, t.projectNumber, t.projectName, t.projectManager,
            peso(t.budget), formatDateYMD(t.startDate), formatDateYMD(t.endDate), t.priority, t.assignedTeam,
            t.status,
            (t.status === 'Pending')
              ? `<button class="btn btn-sm btn-primary" onclick="approveTicketAdmin('${t.ticketId}')">Approve</button>` : '',
            `<button class="btn btn-sm btn-danger" onclick="deleteTicketAdmin('${t.ticketId}')">Delete</button>`
          ]));
          renderDataTable('#tblAllTickets', rows, true);
          refreshAll();
        }).withFailureHandler(err => alert(err.message || err)).listAllTickets(window.__state.token);
      }

      function approveUser(username) {
        google.script.run.withSuccessHandler(res => {
          alert(res.message);
          loadAdminPage(false);
        }).withFailureHandler(err => alert(err.message || err)).approveUser(window.__state.token, username);
      }

      function approveTicketAdmin(ticketId) {
        if (!confirm('Approve this ticket?')) return;
        google.script.run.withSuccessHandler(res => {
          alert(res.message);
          loadAdminPage(false);
        }).withFailureHandler(err => alert(err.message || err)).approveTicket(window.__state.token, ticketId);
      }

      function deleteTicketAdmin(ticketId) {
        if (!confirm('Delete this ticket? This cannot be undone.')) return;
        google.script.run.withSuccessHandler(res => {
          alert(res.message);
          loadAdminPage(false); // refresh page after deleting
        }).withFailureHandler(err => alert(err.message || err)).deleteTicket(window.__state.token, ticketId);
      }

      /* ============================
         EXPORT PDF
         ============================ */

      function exportPdf(scope) {
        google.script.run.withSuccessHandler(res => {
          if (!res.ok) return alert('Export failed.');
          const link = document.createElement('a');
          link.href = `data:application/pdf;base64,${res.base64}`;
          link.download = res.filename || 'tickets.pdf';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }).withFailureHandler(err => alert(err.message || err)).exportTicketsPdf(window.__state.token, scope);
      }

      /* ============================
         DataTables helper
         ============================ */

      const tables = {};
      function renderDataTable(selector, rows, reset) {
        const el = $(selector);
        if (tables[selector] && reset) {
          tables[selector].clear().destroy();
          el.find('tbody').empty();
        }
        if (!tables[selector]) {
          tables[selector] = el.DataTable({
            data: rows,
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            order: [], // no default order
            columns: el.find('thead th').toArray().map(th => ({ title: th.textContent })),
            deferRender: true,
          });
        } else {
          tables[selector].clear();
          tables[selector].rows.add(rows).draw();
        }
      }

      /* ============================
         On load
         ============================ */
      (function init() {
        showSection('login');
        loadAuthFromStorage();
        // Toggle nav display when auth changes
        const navVisible = !!localStorage.getItem('tk_token');
        document.getElementById('navLinks').style.display = navVisible ? 'block' : 'none';
        document.getElementById('logoutBtn').style.display = navVisible ? 'inline-block' : 'none';
      })();
    </script>

  </body>
</html>
