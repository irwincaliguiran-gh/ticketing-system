
<!-- Includes.html: Bootstrap, jQuery, DataTables, Helpers -->

<!-- Bootstrap 5 -->
<link href="jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrityles -->
https://code.jquery.com/jquery-3.7.1.min.js</script>
<link://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css
https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js</script>
https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js</script>

<style>
  body { background: #f7f9fb; }
  .app-container { max-width: 1200px; margin: 24px auto; }
  .brand-title { font-weight: 700; }
  .nav-link.active { font-weight: 600; }
  .cursor-pointer { cursor: pointer; }
  .hidden { display: none !important; }
  /* Make tables responsive */
  .dataTables_wrapper .row { width: 100%; margin: 0; }
</style>

<script>
  // Global client state
  window.__state = {
    token: null,
    username: null,
    role: null,
    currentView: 'login',
    detailTicketId: null,
    refreshIntervals: {}
  };

  // Generic call wrapper
  function call(name, args, onSuccess, onError) {
    const fn = google.script.run.withSuccessHandler(onSuccess || function(){}).withFailureHandler(onError || function(err){
      console.error(err);
      alert(err && err.message ? err.message : err);
    });
    if (Array.isArray(args)) fn[name].apply(fn, args);
    else if (args !== undefined) fnname;
    else fnname;
  }

  function setAuth(token, username, role) {
    window.__state.token = token;
    window.__state.username = username;
    window.__state.role = role;
    localStorage.setItem('tk_token', token);
    localStorage.setItem('tk_username', username);
    localStorage.setItem('tk_role', role);
    document.getElementById('navUser').innerText = `${username} (${role})`;
  }

  function loadAuthFromStorage() {
    const t = localStorage.getItem('tk_token');
    const u = localStorage.getItem('tk_username');
    const r = localStorage.getItem('tk_role');
    if (t && u && r) {
      setAuth(t, u, r);
      showSection('home');
      refreshAll();
    }
  }

  function logout() {
    localStorage.removeItem('tk_token');
    localStorage.removeItem('tk_username');
    localStorage.removeItem('tk_role');
    window.__state = { token:null, username:null, role:null, currentView:'login', detailTicketId:null, refreshIntervals:{} };
    showSection('login');
  }

  function peso(n) {
    const num = Number(n)||0;
    return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(num);
  }

  function formatDateYMD(d) {
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return '';
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2, '0');
    const dd = String(dt.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  }

  function genTicketId() {
    // Client-side generation by date/time (Philippines)
    const d = new Date();
    const pad = (n, s=2) => String(n).padStart(s, '0');
    const id = `TKT-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}-${pad(d.getMilliseconds(),3)}`;
    return id;
  }

  function showSection(name) {
    document.querySelectorAll('[data-section]').forEach(el => el.classList.add('hidden'));
    const el = document.querySelector(`[data-section="${name}"]`);
    if (el) el.classList.remove('hidden');
    window.__state.currentView = name;

    // Admin visibility
    document.querySelectorAll('.admin-only').forEach(e => {
      e.classList.toggle('hidden', (window.__state.role !== 'Admin'));
    });

    if (name === 'tickets') loadMyTicketsTable();
    if (name === 'admin') loadAdminPage();
    if (name === 'search') { /* no-op */ }
    if (name === 'submit') {
      document.getElementById('ticketId').value = genTicketId();
    }
  }

  function refreshAll() {
    // Real-time periodic refresh (every 15s) for main tables
    clearInterval(window.__state.refreshIntervals.tickets);
    if (window.__state.currentView === 'tickets' || window.__state.currentView === 'admin') {
      window.__state.refreshIntervals.tickets = setInterval(() => {
        if (window.__state.currentView === 'tickets') loadMyTicketsTable(false);
        if (window.__state.currentView === 'admin') loadAdminPage(false);
        if (window.__state.currentView === 'details' && window.__state.detailTicketId) reloadDetail();
      }, 15000);
    }
  }
</script>
